<div th:fragment="calendar" xmlns:th="http://www.w3.org/1999/xhtml">
    <style>
        /* Estilos (se mantienen igual) */
        .proyecto-planificado {
            background: #E3F2FD;
            border-left: 4px solid #1976D2;
            color: #1565C0;
        }

        .proyecto-en-curso {
            background: #B3E5FC;
            border-left: 4px solid #0288D1;
            color: #0277BD;
            font-weight: 600;
        }

        .proyecto-completado {
            background: #C8E6C9;
            border-left: 4px solid #388E3C;
            color: #1B5E20;
        }

        .proyecto-pausado {
            background: #FFE0B2;
            border-left: 4px solid #F57C00;
            color: #E65100;
        }

        .proyecto-retrasado {
            background: #FFCDD2;
            border-left: 4px solid #D32F2F;
            color: #B71C1C;
            font-weight: 700;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            margin: 0 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .calendar-grid-day {
            position: relative;
        }

        .calendar-grid-day.hoy {
            background: #FFF9C4;
            border: 2px solid #F57F17;
        }

        .calendar-grid-day.hoy::after {
            content: "HOY";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            font-weight: bold;
            color: #F57F17;
        }
    </style>

    <div class="bg-white dark:bg-gray-900 rounded-xl p-4 shadow-sm flex flex-col h-full">

        <div th:if="${cantRiesgoPersonal > 0}"
            class="mb-6 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-r shadow-sm animate-pulse">
            <div class="flex items-start">
                <div class="flex-shrink-0"><span class="material-symbols-outlined text-red-500">warning</span></div>
                <div class="ml-3 w-full">
                    <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Alerta de Sobrecarga de Personal</h3>
                    <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                        <p class="mb-2">Se ha detectado que el siguiente personal excede las 160h mensuales estimadas:
                        </p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li th:each="alerta : ${personalEnRiesgo}">
                                <span class="font-bold" th:text="${alerta.personal.nombre}"></span>
                                - <span th:text="${alerta.horasComprometidas}"></span> hrs asignadas en <span
                                    th:text="${alerta.proyectosActivos}"></span> proyectos.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="relative flex items-center justify-center w-full mb-4">
            <a th:href="@{/principal(offset=${(offset ?: 0) - 1})}"
                class="absolute left-0 text-gray-800 dark:text-gray-200 flex size-10 items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-outlined">chevron_left</span>
            </a>
            <div class="text-center">
                <p class="mx-auto text-gray-900 dark:text-white text-lg font-bold leading-tight"
                    th:text="${#strings.capitalize(nombreMes)} + ' ' + ${año}"></p>
                <p class="text-xs text-gray-500 dark:text-gray-400 font-mono mt-0.5"
                    th:text="${#temporals.format(#temporals.createNow(), 'HH:mm')}"></p>
            </div>
            <a th:href="@{/principal(offset=${(offset ?: 0) + 1})}"
                class="absolute right-0 text-gray-800 dark:text-gray-200 flex size-10 items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-outlined">chevron_right</span>
            </a>
        </div>

        <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg overflow-x-auto">
            <div class="flex whitespace-nowrap text-xs gap-3">
                <span class="legend-item proyecto-planificado">▪ Planificado</span>
                <span class="legend-item proyecto-en-curso">▪ En Curso</span>
                <span class="legend-item proyecto-completado">▪ Completado</span>
                <span class="legend-item proyecto-pausado">▪ Pausado</span>
                <span class="legend-item proyecto-retrasado">▪ Retrasado</span>
            </div>
        </div>

        <div class="flex-1 flex flex-col min-h-0 overflow-hidden">

            <div class="overflow-x-auto flex-1">

                <div class="min-w-[800px] min-h-[600px] h-full flex flex-col">

                    <div class="grid grid-cols-7 gap-1 mb-2 shrink-0">
                        <p
                            class="text-gray-500 dark:text-gray-400 text-xs font-bold text-center h-8 flex items-center justify-center">
                            Lun</p>
                        <p
                            class="text-gray-500 dark:text-gray-400 text-xs font-bold text-center h-8 flex items-center justify-center">
                            Mar</p>
                        <p
                            class="text-gray-500 dark:text-gray-400 text-xs font-bold text-center h-8 flex items-center justify-center">
                            Mié</p>
                        <p
                            class="text-gray-500 dark:text-gray-400 text-xs font-bold text-center h-8 flex items-center justify-center">
                            Jue</p>
                        <p
                            class="text-gray-500 dark:text-gray-400 text-xs font-bold text-center h-8 flex items-center justify-center">
                            Vie</p>
                        <p
                            class="text-gray-500 dark:text-gray-400 text-xs font-bold text-center h-8 flex items-center justify-center">
                            Sáb</p>
                        <p
                            class="text-gray-500 dark:text-gray-400 text-xs font-bold text-center h-8 flex items-center justify-center">
                            Dom</p>
                    </div>

                    <div class="grid grid-cols-7 gap-1 flex-1">
                        <div th:each="dia : ${dias}"
                            th:class="${dia == hoy ? 'calendar-grid-day hoy' : 'calendar-grid-day'}"
                            class="relative flex flex-col border-2 border-gray-800 dark:border-gray-300 rounded-lg p-1 text-sm text-gray-800 dark:text-gray-200 transition-all duration-200 hover:shadow-md group bg-white dark:bg-gray-800 min-h-[100px]">

                            <span th:text="${dia.dayOfMonth}" class="font-semibold text-xs mb-1"></span>

                            <div class="flex-1 overflow-y-auto text-xs space-y-1 custom-scrollbar">
                                <div th:each="proyecto : ${proyectosPorDia.get(dia) ?: {}}" th:class="${proyecto.estado == 'Completado' ? 'proyecto-completado' :
                                                proyecto.estado == 'En Curso' ? 'proyecto-en-curso' :
                                                proyecto.estado == 'Pausado' ? 'proyecto-pausado' :
                                                proyecto.fechaFin != null and proyecto.fechaFin < hoy and proyecto.estado != 'Completado' ? 'proyecto-retrasado' :
                                                'proyecto-planificado'}"
                                    class="rounded px-2 py-1 cursor-pointer hover:opacity-80 transition-opacity truncate text-[10px]"
                                    th:onclick="'abrirModalProyecto(' + ${proyecto.idProyecto} + ')'">
                                    <span th:text="${proyecto.nombre}"></span>
                                </div>
                            </div>

                            <button type="button"
                                class="mt-1 w-full bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-300 text-[10px] py-0.5 rounded opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity"
                                th:onclick="'abrirModalDia(' + ${dia.dayOfMonth} + ')'">
                                Ver
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Detalles del Día -->
    <div id="modalDia"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 z-50">
        <div
            class="bg-white dark:bg-gray-900 rounded-xl shadow-lg w-[90%] max-w-2xl p-6 text-gray-800 dark:text-gray-200 transform scale-95 transition-transform duration-200 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" id="modalDiaTitle"></h2>
                <button type="button" onclick="cerrarModalDia()"
                    class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">✕</button>
            </div>

            <div id="modalDiaContenido" class="space-y-4">
                <!-- Se llena con JavaScript -->
            </div>

            <div class="flex justify-end mt-6">
                <button type="button" onclick="cerrarModalDia()"
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md text-sm hover:bg-gray-300 dark:hover:bg-gray-600">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Detalle de Proyecto -->
    <div id="modalProyecto"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 z-50">
        <div
            class="bg-white dark:bg-gray-900 rounded-xl shadow-lg w-[90%] max-w-2xl p-6 text-gray-800 dark:text-gray-200 transform scale-95 transition-transform duration-200 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" id="modalProyectoTitle"></h2>
                <button type="button" onclick="cerrarModalProyecto()"
                    class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl">✕</button>
            </div>

            <div id="modalProyectoContenido" class="space-y-3 text-sm">
                <!-- Se llena con datos del proyecto -->
                <p id="proyectoCliente"></p>
                <p id="proyectoEstado"></p>
                <p id="proyectoFechas"></p>
                <p id="proyectoProgramado"></p>
                <div id="proyectoPersonal"></div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="cerrarModalProyecto()"
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md text-sm hover:bg-gray-300">Cerrar</button>
                <a id="btnVerProyecto" href="#" target="_blank"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700">Ver
                    Detalle</a>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // --- VARIABLES GLOBALES (Añadir esto al principio) ---
        // Extraemos el año y mes exactos del primer día de la lista que manda el controlador
        const CurrentYear = [[${ dias[0].year }]];
        const currentMes = [[${ dias[0].monthValue }]];
        // 1. Inyección de datos desde Spring Boot a JavaScript
        const proyectosData = [
            /*[# th:each="proyecto : ${proyectos}"]*/
            {
                id: [[${ proyecto.idProyecto }]],
                nombre: [[${ proyecto.nombre }]],
                descripcion: [[${ proyecto.descripcion }]],
                // Manejo seguro de nulos para cliente
                cliente: [[${ proyecto.cliente != null ? proyecto.cliente.nombre : 'Sin Cliente' }]],
                estado: [[${ proyecto.estado }]],
                inicio: [[${ proyecto.fechaInicio }]], // Formato YYYY-MM-DD
                fin: [[${ proyecto.fechaFin }]],       // Formato YYYY-MM-DD
                presupuesto: [[${ proyecto.presupuestoTotal }]]
            },
            /*[/]*/
        ];

        // --- LÓGICA DEL MODAL DE PROYECTO ---

        function abrirModalProyecto(idProyecto) {
            // Buscar el proyecto en el array de memoria (sin llamar al backend otra vez)
            const proyecto = proyectosData.find(p => p.id === idProyecto);

            if (proyecto) {
                // Llenar títulos y textos básicos
                document.getElementById('modalProyectoTitle').textContent = proyecto.nombre;
                document.getElementById('proyectoCliente').innerHTML = `<strong>Cliente:</strong> ${proyecto.cliente}`;

                // Colorear el estado
                let claseEstado = '';
                switch (proyecto.estado) {
                    case 'Completado': claseEstado = 'text-green-600'; break;
                    case 'En Curso': claseEstado = 'text-blue-600'; break;
                    case 'Retrasado': claseEstado = 'text-red-600'; break;
                    default: claseEstado = 'text-gray-600';
                }
                document.getElementById('proyectoEstado').innerHTML = `<strong>Estado:</strong> <span class="${claseEstado}">${proyecto.estado}</span>`;

                // Fechas y descripción
                document.getElementById('proyectoFechas').innerHTML = `
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div><span class="text-gray-500 text-xs">Inicio:</span><br>${proyecto.inicio}</div>
                        <div><span class="text-gray-500 text-xs">Fin:</span><br>${proyecto.fin}</div>
                    </div>
                `;

                // Descripción (si existe)
                const desc = proyecto.descripcion ? proyecto.descripcion : 'Sin descripción disponible';
                document.getElementById('proyectoProgramado').innerHTML = `<div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">${desc}</div>`;

                // Actualizar botón de "Ver Detalle"
                const btnVer = document.getElementById('btnVerProyecto');
                // Asumiendo que tienes una ruta para ver el detalle completo
                btnVer.href = `/proyectos/detalle/${proyecto.id}`;

                // Mostrar Modal
                const modal = document.getElementById('modalProyecto');
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('div').classList.remove('scale-95');
            }
        }

        function cerrarModalProyecto() {
            const modal = document.getElementById('modalProyecto');
            if (modal) {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-100');
                modal.querySelector('div').classList.add('scale-95');
                modal.querySelector('div').classList.remove('scale-100');
            }
        }

        // --- LÓGICA DEL MODAL DE DÍA ---

        function abrirModalDia(diaNumero) {
            const modal = document.getElementById('modalDia');
            const contenido = document.getElementById('modalDiaContenido');
            const titulo = document.getElementById('modalDiaTitle');

            // 1. Array de nombres para el título
            const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const nombreMes = nombresMeses[currentMes - 1];

            titulo.textContent = `Agenda del ${diaNumero} de ${nombreMes} del ${CurrentYear}`;
            contenido.innerHTML = '';

            // Helper para padding (05 en lugar de 5)
            const pad = (n) => n.toString().padStart(2, '0');

            // Construcción de la fecha ISO para comparación
            const mesStr = pad(currentMes);
            const diaStr = pad(diaNumero);
            const fechaSeleccionada = `${CurrentYear}-${mesStr}-${diaStr}`;

            // 2. Filtrar proyectos
            const proyectosDelDia = proyectosData.filter(p => {
                if (!p.inicio) return false;

                const yaEmpezo = fechaSeleccionada >= p.inicio;
                const noHaTerminado = !p.fin || fechaSeleccionada <= p.fin;

                return yaEmpezo && noHaTerminado;
            });

            // 3. Generar el HTML
            if (proyectosDelDia.length > 0) {
                let html = '<ul class="space-y-3">';

                proyectosDelDia.forEach(p => {
                    // Asignar clases de color según estado (coherente con tu CSS)
                    let colorBorder = "border-l-4 border-gray-400";
                    let bgClass = "bg-gray-50";
                    let textClass = "text-gray-700";

                    if (p.estado === 'Completado') {
                        colorBorder = "border-l-4 border-accent-green";
                        bgClass = "bg-green-50";
                        textClass = "text-green-800";
                    } else if (p.estado === 'En Curso') {
                        colorBorder = "border-l-4 border-blue-500";
                        bgClass = "bg-blue-50";
                        textClass = "text-blue-800";
                    } else if (p.estado === 'Retrasado') {
                        colorBorder = "border-l-4 border-danger";
                        bgClass = "bg-red-50";
                        textClass = "text-red-800";
                    } else if (p.estado === 'Pausado') {
                        colorBorder = "border-l-4 border-accent-orange";
                        bgClass = "bg-orange-50";
                        textClass = "text-orange-800";
                    }

                    html += `
                <li class="relative p-3 rounded shadow-sm border border-gray-100 ${bgClass} ${colorBorder}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-sm ${textClass}">${p.nombre}</h4>
                            <p class="text-xs text-gray-500 mt-0.5">
                                <span class="material-symbols-outlined text-[10px] align-middle">person</span> 
                                ${p.cliente}
                            </p>
                        </div>
                        <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full bg-white/50 border border-black/5 text-gray-600">
                            ${p.estado}
                        </span>
                    </div>
                    
                    <div class="mt-2 flex items-center justify-between">
                         <div class="text-[10px] text-gray-500">
                            ${p.inicio} <span class="mx-1">➝</span> ${p.fin ? p.fin : '...'}
                         </div>
                         <button onclick="cerrarModalDia(); abrirModalProyecto(${p.id});" 
                            class="text-xs font-semibold text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1">
                            Ver Detalle <span class="material-symbols-outlined text-[12px]">open_in_new</span>
                         </button>
                    </div>
                </li>`;
                });

                html += '</ul>';
                html += `<p class="text-xs text-center text-gray-400 mt-4 border-t pt-2">Total: ${proyectosDelDia.length} proyecto(s) activo(s) este día.</p>`;

                contenido.innerHTML = html;
            } else {
                // Estado Vacío (Empty State)
                contenido.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                    <span class="material-symbols-outlined text-5xl mb-2 opacity-30">event_available</span>
                    <p class="text-sm">No hay proyectos activos programados para el ${diaNumero} de ${nombreMes}.</p>
                </div>
            `;
            }

            // 4. Mostrar el modal
            modal.classList.remove('opacity-0', 'pointer-events-none');
            const modalPanel = modal.querySelector('div');
            if (modalPanel) {
                modalPanel.classList.remove('scale-95');
                modalPanel.classList.add('scale-100');
            }
        }

        /* --- LÓGICA DEL MODAL DE DÍA --- */

        function cerrarModalDia() {
            const modal = document.getElementById('modalDia');
            if (modal) {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-100'); // Asegura que se quite la clase de visibilidad si la tienes
                modal.querySelector('div').classList.add('scale-95');
                modal.querySelector('div').classList.remove('scale-100');
                document.body.style.overflow = ''; // Restaura scroll si fue bloqueado
            }
        }

        // --- EVENT LISTENERS GLOBALES ---

        // Cerrar modales al hacer clic fuera (Overlay)
        window.onclick = function (event) {
            const modalDia = document.getElementById('modalDia');
            const modalProy = document.getElementById('modalProyecto');
            if (event.target == modalDia) cerrarModalDia();
            if (event.target == modalProy) cerrarModalProyecto();
        }

        // Cerrar con tecla ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                cerrarModalDia();
                cerrarModalProyecto();
            }
        });
    </script>
</div>